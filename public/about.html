<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    
</head>
<style>
    * {
    margin: 0;
    padding: 0;
    box-sizing: border-box; /* Optional, but helps with sizing */
}
.red{
    user-select: none; /* Prevent text selection */
    -webkit-user-select: none; /* Safari */
    -moz-user-select: none; /* Firefox */
     padding:5px 20px;
     box-sizing: border-box;
    display: inline-block;
   background-color: white;
   box-shadow: 0px 10px 15px -3px rgba(0,0,0,0.1);
    color :green;
    text-align: center;
    font-family: Arial, Helvetica, sans-serif;
   margin-top: 7px;
    border-radius: 10px;

}
.red:hover{
    cursor: pointer;
    background-color: white;
    border:1px solid grey;
    color:blue;
}
#con{
    flex-direction: column;
    display: flex;
  
    align-items: center;

    width:80%;
      /* From https://css.glass */
background: rgba(255, 255, 255, 0.31);
border-radius: 16px;
box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
backdrop-filter: blur(6.7px);
-webkit-backdrop-filter: blur(6.7px);
border: 1px solid rgba(255, 255, 255, 0.12);
    min-height: 50%;
 
    box-shadow: 0px 10px 15px -3px rgba(0,0,0,0.1);
    border-radius: 10px;
    margin-top: 100px;
    padding:10px;
    border-top: 5px solid rgb(248, 247, 137);
  
    box-sizing: border-box;
    animation: con 1s ease-in-out;

  
}
#list{

display: flex;
margin-top: 20px;
align-items: center;
flex-direction: column;
height:200px;
overflow-y: auto;
}
html{
    height:100%;
}
body{
    background: url(https://i.pinimg.com/736x/70/17/db/7017db307c867df7fa8791e1628915f1.jpg);
    background-position: center;
    background-size: cover;
    min-width:100%;
    height:100%;
    padding:0px;
    margin:0px;
    box-sizing: border-box;
    flex-direction: column;
    font-family: Georgia, 'Times New Roman', Times, serif;
    display: flex;

    align-items: center;
  
}
#con  h2{
    text-align: center;
    background: -webkit-linear-gradient(0deg, white 0%, yellow 46%);
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
   
}
.status{
    width:auto;
    height:auto;
    background-color: green;
    border-radius: 12px;
    padding:10px;
    position: absolute;
    top:10px;
    z-index: 2;
    animation: ani 1s infinite;
    font-size: 10px;
    user-select: none; /* Prevent text selection */
    -webkit-user-select: none; /* Safari */
    -moz-user-select: none; /* Firefox */

}
.status:hover{
   cursor: pointer;
   background-color: black;
   color:white;
}

@keyframes ani {
    0%{
        background-color: yellow;
        box-shadow: 0px 0px 15px 3px red;
    
    }

    100%{
        background-color: pink;
        box-shadow: 0px 0px 5px -3px green;
    
    }
}


.localv{
     width:30%;
     height:30%;
     border-radius: 12px;
     position: absolute;
     top:10px;
     left:10px;
     box-shadow: 0px 10px 15px -3px rgba(0,0,0,0.1);
     border:none;
     z-index: 1;
     object-fit: cover;

}
.remotev{
 width:100%;
 height:100%;
object-fit: cover;
 z-index: 0;
 
}
#videoid{
    flex-direction: column ;
    display: none;
    width:100% ;
    height:100%;
    position: absolute;
    top:0px;
    left:0px;
    overflow: hidden;
  margin-top: 0px;

}
.videoclass{
  display: flex !important;
  justify-content: center;
  align-items: center;
}
video{

    border:1px solid black;
  
   background: url(https://img.freepik.com/premium-vector/man-avatar-profile-picture-vector-illustration_268834-538.jpg);
   background-size: cover;
   background-position: center;
}
#status{
    width:100px;
    height:auto;
    box-shadow: 0px 10px 15px -3px rgba(0,0,0,0.1);
    position: relative;top:10px;
    right:10px;
    z-index: 2;
    user-select: none; /* Prevent text selection */
    -webkit-user-select: none; /* Safari */
    -moz-user-select: none; /* Firefox */
}
#end{
    position: absolute;
    bottom:40px;
    right:40px;
    font-size: large;
    padding:7px 16px;
    border-radius: 10px;
    border:none;
    background-color: red;
    color:white;

    box-shadow: 0px 10px 15px -3px rgba(0,0,0,0.1);
}
#about{
    width:80%;
    height:auto;
    margin-top: 10px;
    /* From https://css.glass */
background: rgba(255, 255, 255, 0.31);
border-radius: 16px;
box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
backdrop-filter: blur(6.7px);
-webkit-backdrop-filter: blur(6.7px);
border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 12px;
    box-shadow: 0px 10px 15px -3px rgba(0,0,0,0.1);
    box-sizing: border-box;
    padding:17px 13px;
   
    border-bottom: 4px solid rgb(2, 255, 255);
}
#about p {
      font-size: 13px;
      color:white;
      margin-bottom: 8px;
      font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
}
#about span{
    color:rgb(0, 203, 254);
}
.h4{
    font-size: 14px !important;
    color:rgb(0, 203, 254) !important;
    margin-bottom: 4px !important;
   
    
}
@keyframes con {
    0%{ transform: scaleY(0);}

 
       
    
    100%{
            transform: scaleY(1);
       
    }
}
#talkbtn{
    position: fixed;
    top:30px;
    right:50px;
    background-color: rgb(0, 135, 245);
    padding:6px 6px;
    box-sizing: border-box;
    color :white;
    box-shadow: 0px 10px 15px -3px rgba(0,0,0,0.1);
    border-radius: 5px;
    font-size: 12px;
    border:none;
    
    
}
#talkbtn:hover{
    box-shadow: 0px 0px 15px 1px rgb(246, 255, 0);
    cursor: pointer;
    background-color: white;
    color:black;
}
#clickcon{
    flex-direction: column;
    display: flex;
  
    align-items: center;

    width:80%;
      /* From https://css.glass */
background:white;
border-radius: 16px;
    

    min-height: 30%;
 
    box-shadow: 0px 10px 15px -3px rgba(0,0,0,0.1);
    border-radius: 10px;
    margin-top: 100px;
    padding:10px;
    border-top: 5px solid rgb(248, 247, 137);
   display: none;
    box-sizing: border-box;
    animation: con 1s ease-in-out;

}
.clickconclass{
   display:flex !important;
   justify-content: center;
   align-items: center;


}
#clickcon h3{
    text-align: center;
}
.talkbtnclass{
    background-color: rgb(0, 0, 0) !important;
    color:#ffffff !important;
    
    
}
.delay{
    animation: delay 3s ease-in-out;
    color:#006167;
    margin-top: 10px;
}
.delays{
      animation: delays 4s  ease-in-out;
    color:#006167;
    margin-top: 10px;
}
@keyframes delay {
     0%{opacity: 0;}
     50%{opacity: 0;}
     100%{opacity: 1;}
}
@keyframes delays {
     0%{opacity: 0;}
     50%{opacity: 0;}
     100%{opacity: 1;}
}
.dan{
    color:#0049ff;
}
</style>
<body>
    <div id="status" onclick="acceptf()"></div>
    <button id ="talkbtn">click me</button>
    <div id = "clickcon">
        <h3>Thet Naing Tun Want To <span class="dan">Dance!</span></h3>
        <h3 class="delay">Only with you Diyalu.</h3>
        <h3 class="delays">It is dance time!ðŸ¥º</h3>
    </div>
    <div id="videoid">
        <video id="localv" autoplay muted></video>
        <video id="remotev" autoplay></video>
        <button id="end">END</button>
    </div>

    <div id="con">
        <h2>Online Users</h2>
        <div id="list"></div>
    </div>
    <div id="about">
        <p class="h4">About This Page</p>
        <p>This is a video calling website.Created by <span>Thet Naing Tun / Shiv Prakash</span> in 2024 october 1.</p>
        <p>In this website you can easily video chat with anyone who is online.No name need,No account need to create
            to use this video chat.Just click someone who is online and enjoy your day.
            <span>click "Receiving call..." to accept the call.</span>
        </p>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const talkbtn = document.getElementById("talkbtn");
        const clickcon = document.getElementById("clickcon");
        const status = document.getElementById("status");
        const con = document.getElementById("con");
        const videocon = document.getElementById("videoid");
        const remotev = document.getElementById("remotev");
        const localv = document.getElementById("localv");
        const about = document.getElementById("about");
        let peer;
        // click btn //
         talkbtn.addEventListener("click",()=>{
            
            if(talkbtn.classList.contains("talkbtnclass")){
           
              con.style.display = "block";
              clickcon.classList.remove("clickconclass");
              talkbtn.classList.remove("talkbtnclass");
            }else{
                clickcon.classList.add("clickconclass");
            con.style.display = "none";
            talkbtn.classList.add("talkbtnclass");
            }

         })
      
        
        //
        const iceServers = [
            { urls: "stun:stun.l.google.com:19302" },
            { urls: "stun:stun1.l.google.com:19302" },
            { urls: "stun:stun2.l.google.com:19302" }
        ];
    
        let myid;
        socket.on("myid", (id) => {
            myid = id;
            console.log("id =", id, "my id =", myid);
        });
    
        socket.on("userlist", (d) => {
            const div = document.getElementById("list");
            div.innerHTML = "";
            d.forEach(id => {
                if (id !== myid) {
                    div.innerHTML += `<p class="red" id="${id}" onclick="calling('${id}')" >${id}</p>`;
                }
            });
            console.log(d);
        });
    let localstream;
        async function createPeerConnection(callerId) {
            peer = new RTCPeerConnection({ iceServers });
             localstream = localv.srcObject;
    
            // Add local stream tracks to peer connection
            localstream.getTracks().forEach(track => peer.addTrack(track, localstream));
    
            peer.ontrack = event => {
                
                remotev.srcObject = event.streams[0];
                
            };
    
            peer.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit("icecandidate", { candidate: event.candidate, to: callerId });
                }
            };
        }
    
        socket.on("icecandidate", async (data) => {
            const { candidate } = data;
            if (candidate) {
                await peer.addIceCandidate(new RTCIceCandidate(candidate));
            }
        });
    
        async function calling(to) {
            clickcon.classList.remove("clickconclass");
            talkbtn.classList.remove("talkbtnclass");
             about.style.display = "none";
            remotev.classList.add("remotev");
            localv.classList.add("localv");
            con.style.display = "none";
            videocon.classList.add("videoclass");
            status.innerHTML = "Calling....";
            status.classList.add("status");
            document.getElementById(to).style.backgroundColor = "red";
    
            try {
                await createPeerConnection(to);
                const localOffer = await peer.createOffer();
                await peer.setLocalDescription(new RTCSessionDescription(localOffer));
                socket.emit("outgoingcall", { fromoffer: localOffer, to });
            } catch (error) {
                console.error("Error accessing media devices.", error);
                status.innerHTML = "Error accessing camera/microphone: " + error.message;
                status.classList.add("error");
            }
        }
    
        let caller;
let calleroffer;

// Incoming call handler
socket.on("incommingcall", async data => {
  
    status.innerHTML = "Receiving call...";
    status.classList.add("status");
    console.log("Incoming call...");
    status.style.display ="block";
    const { from, offer } = data;
    caller = from; // Store the caller's ID
    calleroffer = offer; // Store the offer

    await createPeerConnection();
    await peer.setRemoteDescription(new RTCSessionDescription(offer));
});

// Accept function to be called when user clicks to accept the call
async function acceptf() {
    about.style.display = "none";
    remotev.classList.add("remotev");
            localv.classList.add("localv");
                clickcon.classList.remove("clickconclass");
              talkbtn.classList.remove("talkbtnclass");
            
    status.style.display ="none";
    console.log("Answering...");
    con.style.display = "none";
    videocon.classList.add("videoclass");
    const answeroffer = await peer.createAnswer();
    await peer.setLocalDescription(new RTCSessionDescription(answeroffer));

    // Send the answer offer to the caller
    socket.emit("callaccepted", { answer: answeroffer, to: caller });
}

    
        socket.on("incomminganswer", async data => {
            const { answer } = data;
            status.style.display = "none";
            await peer.setRemoteDescription(new RTCSessionDescription(answer));
        });
    
        const getUserMedia = async (myid) => {
    try {
        const user = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localv.srcObject = user;
        localstream = user;
        return user;

       

    } catch (error) {
        alert(`Error accessing media devices: ${error.message}`);
    }
};

    
        window.addEventListener("load", async () => {
             await getUserMedia(myid);
           
        });

const endcall = document.getElementById("end");
endcall.addEventListener("click",async()=>{

 location.reload()
})
    </script>
    
</body>
</html>
